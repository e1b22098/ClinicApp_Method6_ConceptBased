<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.clinic.booking.mapper.BookingMapper">

    <resultMap id="bookingResultMap" type="com.clinic.booking.model.Booking">
        <id property="bookingId" column="booking_id"/>
        <result property="patientId" column="patient_id"/>
        <result property="bookingDate" column="booking_date"/>
        <result property="bookingTime" column="booking_time"/>
        <result property="status" column="status"/>
        <association property="patient" javaType="com.clinic.booking.model.Patient">
            <id property="patientId" column="p_patient_id"/>
            <result property="name" column="p_name"/>
            <result property="phoneNumber" column="p_phone_number"/>
        </association>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="bookingId">
        INSERT INTO bookings (patient_id, booking_date, booking_time, status)
        VALUES (#{patientId}, #{bookingDate}, #{bookingTime}, #{status})
    </insert>

    <select id="findById" resultMap="bookingResultMap">
        SELECT b.booking_id, b.patient_id, b.booking_date, b.booking_time, b.status,
               p.patient_id as p_patient_id, p.name as p_name, p.phone as p_phone_number
        FROM bookings b
        LEFT JOIN patients p ON b.patient_id = p.patient_id
        WHERE b.booking_id = #{bookingId}
    </select>

    <select id="findByPatientId" resultType="com.clinic.booking.model.Booking">
        SELECT booking_id as bookingId, 
               patient_id as patientId, 
               booking_date as bookingDate, 
               booking_time as bookingTime, 
               status
        FROM bookings
        WHERE patient_id = #{patientId}
        AND status = 'ACTIVE'
        ORDER BY booking_date ASC, booking_time ASC
    </select>

    <select id="findByDate" resultMap="bookingResultMap">
        SELECT b.booking_id, b.patient_id, b.booking_date, b.booking_time, b.status,
               p.patient_id as p_patient_id, p.name as p_name, p.phone as p_phone_number
        FROM bookings b
        LEFT JOIN patients p ON b.patient_id = p.patient_id
        WHERE b.booking_date = #{bookingDate}
        AND b.status = 'ACTIVE'
        ORDER BY b.booking_time ASC
    </select>

    <select id="findByDateAndTime" resultMap="bookingResultMap">
        SELECT b.booking_id, b.patient_id, b.booking_date, b.booking_time, b.status,
               p.patient_id as p_patient_id, p.name as p_name, p.phone as p_phone_number
        FROM bookings b
        LEFT JOIN patients p ON b.patient_id = p.patient_id
        WHERE b.booking_date = #{bookingDate}
        AND b.booking_time = #{bookingTime}
        AND b.status = 'ACTIVE'
    </select>

    <update id="updateStatus">
        UPDATE bookings
        SET status = #{status}
        WHERE booking_id = #{bookingId}
    </update>

    <delete id="delete">
        DELETE FROM bookings
        WHERE booking_id = #{bookingId}
    </delete>

</mapper>
